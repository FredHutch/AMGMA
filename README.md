# Annotation of Microbial Genomes by Microbiome Association (AMGMA)

The purpose of this repository is to allow users to annotate a collection of
microbial genomes on the basis of their association with microbiome survey
datasets. 

### Background

Diving more deeply, every microbial genome can be viewed as consisting of a
collection of genetic components, such as genes. In turn, each of those genetic
components (e.g. genes) can be associated with some outcome of interest via
the analysis of microbiome surveys by metagenomic sequencing. The tool most easily
used for this purpose (and compatible for downstream analysis by AMGMA) is
[GeneShot](https://www.github.com/Golob-Minot/GeneShot).

After each microbial gene has been associated with outcome of interest (such
as a particular human disease), then those association metrics can be summarized
over a set of microbial genomes by:

  1. Aligning the reference genes against each genome's genes, and
  2. Calculating summary metrics for each genome, such as:
    * Proportion of genes passing FDR filter for association
    * Average estimated coefficient of association for those genes
  3. Formatting a genome 'map' showing the relative physical location for those genes throughout the genome

### Running AMGMA

_Formatting a Reference Genome Database_:

Using a collection of reference genomes, run the `AMGMA/build_db` script.

Input data for this step is simply a collection of microbial genomes, and
a manifest CSV file listing those genomes. The CSV must have the following
columns: `uri,id,name`:

  * `uri`: Location of the genome FASTA
  * `id`: Unique alphanumeric ID for each genome
  * `name`: Longer description of each genome, with whitespaces allowed (but no commas)

_Annotate Reference Genomes_:

Using that genome database, annotate with a set of microbiome association results
generated by `geneshot` with the main `AMGMA` executable.

### How AMGMA Works

The concept of AMGMA is that it will compare a set of genes from an external
gene catalog against a collection of genomes. Each of those 'catalog genes'
has been associated with some measure(s) of interest using the intermediate
entity of Co-Abundant Gene Groups (CAGs). Each CAG has been analyzed for its
estimated coefficient of association with some measure of interest, and we
also have a p-value for that association. At the level of the CAGs, we can
apply some False Discovery Rate (FDR) correction, and then propagate those
corrected p-values and estimated coefficients to each of the catalog genes
found within each CAG.

The next step is to figure out which of the 'catalog genes' is present in each
of the reference genomes, along with the position of those genes in the genome.
We do this by:
  1. Identifying all of the protein-coding regions in each genome, 'genome genes'
  2. Clustering those 'genome genes' by percent identity making 'genome centroids'
  3. Aligning the 'catalog genes' against the 'genome centroids'
  4. Summarizing each genome on the basis of the estimated coefficient and 
  FDR-corrected p-value for each 'catalog gene', going through the intermediate
  step of 'genome centroids' and finally to 'genome genes.'

### Database Format

The reference database made with the `build_db` script will create two files,
a DMND database of 'genome centroids', and an HDF store with a few tables:

  * `/manifest`: The manifest used to build the database
  * `/genome_centroids`: A table linking each `genome_gene` to a `genome_centroid`
  * `/genomes/<id>`: A table with the `genome_gene` for each genome, by `id`


### Output Format

After running the main `AMGMA` script, two output files will be created, one
with the full results, and one with a summary. These will both be HDF files
and will include everything present in the HDF file used as an input (matching
the output from `geneshot`). The idea is that `geneshot` was run in such a way
as to include some statistical analysis testing for the association of every
individual CAG with some features of interest. And so there may be estimated
coefficients of association for multiple `<feature>` elements in the HDF file
used as input for `AMGMA`, whose output will then include the additional tables:

  * `/genomes/summary/<feature>`: A table with summary metrics for each genome
  * `/genomes/detail/<feature>/<id>`: For each genome, a map of gene locations
