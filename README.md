# Annotation of Microbial Genomes by Microbiome Association (AMGMA)

The purpose of this repository is to allow users to annotate a collection of
microbial genomes on the basis of their association with microbiome survey
datasets.

### Background

Diving more deeply, every microbial genome can be viewed as consisting of a
collection of genetic components, such as genes. In turn, each of those genetic
components (e.g. genes) can be associated with some outcome of interest via
the analysis of microbiome surveys by metagenomic sequencing. The tool most easily
used for this purpose (and compatible for downstream analysis by AMGMA) is
[GeneShot](https://www.github.com/Golob-Minot/GeneShot).

After each microbial gene has been associated with outcome of interest (such
as a particular human disease), then those association metrics can be summarized
over a set of microbial genomes by:

  1. Aligning the reference genes against each genome,
  2. Calculating summary metrics for each genome using both the consistency and magnitude of assocation for each gene it contains, and
  3. Formatting a genome 'map' showing the relative physical location for those genes throughout the genome

### Running AMGMA

_Formatting a Reference Genome Database_:

Using a collection of reference genomes, run the `AMGMA/build_db` script.

Input data for this step is simply a collection of microbial genomes, and
a manifest CSV file listing those genomes. The CSV must have the following
columns: `uri,id,name`:

* `uri`: Location of the genome FASTA
* `id`: Unique alphanumeric ID for each genome
* `name`: Longer description of each genome, with whitespaces allowed (but no commas)

```
Usage:

nextflow run FredHutch/AMGMA/build_db.nf <ARGUMENTS>

Required Arguments:
  --manifest            CSV file listing samples (see below)
  --output_folder       Folder to write output files to
  --output_prefix       Prefix to use for output file names

Optional Arguments:
  --batchsize           Number of genomes to process in a given batch (default: 100)

Manifest:
  The manifest is a CSV listing all of the genomes to be used for the database.
  The manifest much contain the column headers: uri,id,name
  The URI may start with ftp://, s3://, or even just be a path to a local file.
  The ID must be unique, and only contain a-z, A-Z, 0-9, or _.
  The NAME may be longer and contain whitespaces, but may not contain a comma.
```

_Annotate Reference Genomes_:

Using that genome database, annotate with a set of microbiome association results
generated by `geneshot` with the main `AMGMA` executable. Note: `AMGMA v0.4` and
later require inputs from `geneshot v0.9` and later.

```
Usage:

nextflow run FredHutch/AMGMA <ARGUMENTS>

Required Arguments:
--db                  AMGMA database(s) (ends with .tar), with commas delimiting multiple databases
--geneshot_folder     Folder containing geneshot results, which includes:
                        - Results HDF file output by geneshot (*results.hdf5)
                          [overridden by --geneshot_results_hdf]
                        - Detailed HDF file output by geneshot (*details.hdf5)
                          [overridden by --geneshot_detail_hdf]
                        - FASTA file containing the gene catalog (annot/ref.fasta.gz)
                          [overridden by --geneshot_fasta]
--output_folder       Folder used to write outputs
--output_prefix       Prefix appended to files in the output directory

Optional Arguments:
--min_coverage        Minimum coverage required for alignment (default: 50)
--min_identity        Minimum percent identity required for alignment (default: 80)
--top                 Threshold used to retain overlapping alignments within --top% score of the max score (default: 5)
--fdr_method          Method used for FDR correction (default: fdr_bh)
--alpha               Alpha value used for FDR correction (default: 0.2)
--blast               Align with BLAST+ instead of DIAMOND
--no_associations     Exclude all analysis of CAG association metrics
--min_cag_size        Only include details for CAGs containing at least this number of genes (default: 5)
--min_cag_prop        Only include details for CAGs which align with this proportion of genes to a given genome (default: 0.25)

Output HDF:
The primary output from AMGMA is formatted in HDF5 (${OUTPUT_PREFIX}.hdf5) to combine multiple tables
into a single file. An additional output file is formatted as a Redis database file (*.rdb) for rapid
retrieval. Data includes:

* /genomes/manifest (Table with the description of all genomes used for alignment)
* /genomes/cags/containment (Table with the number of genes aligned for all CAGs against all genomes)
* /genomes/raw_abundance (Table with the proportion of gene copies per genome, per specimen)
* /genomes/imputed_abundance (Table with the imputed relative abundance per genome, per specimen)
* /genomes/detail/<genome_id> (Table with the coordinates of all aligned genes for a given genome)
* /genomes/annotation/<genome_id> (Table with the annotations from optional GFF input)
* /genomes/association/<parameter> (Table with estimated associations of all genomes against an experimental parameter)

```

### Example Outputs

_/genomes/cags/containment_:

| CAG | cag_prop | containment | genome | genome_bases | genome_prop | n_genes |
| --- | --- | --- | --- | --- | --- | --- |
| 0 | 0.9701 | 0.9701 | GCF_000840245 | 40890 | 0.8430 | 65 |
| 0 | 0.0895 | 0.0895 | NC_000913.3 | 2495 | 0.0005 | 6 |
| 1 | 0.8888 | 0.9630 | GCF_000819615 | 5187 | 0.9630 | 8 |
| 0 | 0.9701 | 0.9701 | GCF_000840245_FTP | 40890 | 0.8430 | 65 |

_/genomes/summary/label1_:

| genome_id | mean_est_coef | n_pass_fdr | parameter | prop_pass_fdr | total_genes |
| --- | --- | --- | --- | --- | --- |
| GCF_000840245 | 0.1912 | 38 | label1 | 0.65 | 66 |
| NC_000913.3 | -0.0056 | 1 | label1 | 0.12 | 6 |
| GCF_000819615 | 0.0581 | 7 | label1 | 0.8 | 8 |
| GCF_000840245_FTP | 0.0272 | 58 | label1 | 0.84 | 66 |

### How AMGMA Works

The concept of AMGMA is that it will compare a set of genes from an external
gene catalog against a collection of genomes. Each of those 'catalog genes'
has been quantified across an experiment by alignment of raw reads against
that gene catalog. Using that gene-level abundance information, we can compute
the relative abundance of each genome as the combined relative abundance
of the collection of genes which are encoded in a particular genome. Note
that this will only start to approximate the relative abundance of the
actual organism represented by that genome when the complete set of genes
contained in the genome are detected in the experimental data.

As part of the `geneshot` results, we are also able to identify the various
aspects of experimental design, including a manifest describing specimen
attributes and a formula provided by the user to indicate which columns
should be analyzed for associations with microbial relative abundance.
This pipeline will use that information to estimate the association of
microbes which share the set of genes found in each genome against the
experimental design.

The next step is to figure out which of the 'catalog genes' is present in each
of the reference genomes, along with the position of those genes in the genome.
We do this by directly aligning each reference genome against the gene catalog,
using conceptual six-frame translation with DIAMOND in 'blastx' mode and only
retaining alignments which are the highest scoring for each predicted coding
region of the genome. Genomes are aligned in parallel in batches, which also
protects against any sensitivity degradation which might be caused by large
query size. After that alignment step, we then summarize each genome
on the basis of the estimated coefficient and FDR-corrected p-value for each
group of catalog genes.

### Database Format

The reference database made with the `build_db` script will create a single
tarball containing a manifest CSV as well as a set of collection of further
nested tarballs (one for each set of `--batchsize` genomes) containing the
genome sequences for that batch of genomes. One additional file is contained
in those tarballs, which is a table identifying which nucleotide sequence
header corresponds to which reference genome in the concatenated FASTA file.

### Output Format

After running the main `AMGMA` script, a set of output files will be created
which contain the `AMGMA` results. In versions prior to `v0.4` those output
files would have also included all of the `geneshot` results, but that behavior
has been deprecated.

### Genome Abundance

The concept of relative abundance can be applied to genomes within the context
of gene-level metagenomics by expressing it as the aggregate relative abundance
of the gene copies in a specimen which are homologous to sequences contained
in a given reference genome. This will only approximate the relative abundance
of the organism which was used to generate the reference genome when the physical
specimen contains an organism whose genome has the same genetic content.

In order to encompass the widest range of applications, `AMGMA` will calculate
relative abundance for genomes in two complementary ways. To understand the
differences between these approaches, we will consider the cases in which (a)
two genomes are provided which are identical, and (b) two genomes are provided
of which one contains genes which are all present in the specimens in the
experiment, while the other contains an extra set of 10 genes which are not
present or measured in the experiment.

The 'raw' abundance will capture the proportion of gene copies measured in a
specimen which have sequence similarity to a given reference genome above a set
threshold. In the 'raw' abundance, a pair of genomes which share the same set
of genes would both have the same abundance. Similarly, a genome with ten
additional genes would be measured at exactly the same abundance, since those
ten additional genes have zero reads aligned to them in the experiment.

The 'imputed' abundance will use mixture modeling to identify the unique set
of genomes which *best* account for the gene-level abundances observed in the
experiment using a non-negative least squares (NNLS) approach. In this approach,
each genome is represented as a binary vector indicating which genes from the
catalog have significant sequence similarity to the genome. For each specimen,
NNLS is used to estimate the relative abundance vector of individual genomes
which would best produce the observed abundances of genes from the catalog.
In this approach, two genomes with the exact same content should be considered
and edge case (and generally avoided) because NNLS would stochastically assign
abundance to either genome with no impact on the optimization output. For this
reason, any exactly matching genomes will be deduplicated prior to NNLS. The
more interesting application of this 'inputed' abundance is case (b) above in
which one genome contains an extra set of genes which are not present in the
specimens. In that case, the genome which is a better match to the organisms
in the experiment will be assigned all of the relative abundance for those
shared genes, since that assignment is a better fit to the underlying data.
This approach will yield the best results when the collection of genomes used
are all unique, and all contain accurate representations of the genetic content
of organisms present in the specimens. In the case of high-quality reference
genome databases, this mixture modeling can be used to robustly perform
strain-level abundance estimation.
